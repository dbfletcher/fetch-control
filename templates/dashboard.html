{# 1. Define the recursive macro at the absolute top #}
{% macro render_bin(bin, level, items, bins, locations, current_household_id) %}
    {# Scale UI elements based on depth level #}
    {% set header_height = 180 - (level * 30) if level < 4 else 80 %}
    {% set thumb_size = 50 - (level * 5) if level < 4 else 30 %}
    {% set bin_items = items | selectattr("bin_id", "equalto", bin.id) | list %}

    <div class="bin-card" style="margin-left: calc({{ level }} * 25px); border-left: {{ '4px solid var(--primary)' if level > 0 else 'none' }}; margin-bottom: 25px;">
        <div class="bin-photo-container" style="height: {{ header_height }}px; background: #dfe6e9; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden;">
            {% if bin.location_image %}
                <a href="/highres/{{ bin.location_image }}" target="_blank">
                    <img src="/lowres/{{ bin.location_image }}" title="Click for High-res" style="width: 100%; height: 100%; object-fit: cover;">
                </a>
                <form action="/delete-location-photo/{{ bin.id }}" method="post" style="position:absolute; top:8px; right:8px;" onsubmit="return confirm('Delete bin photo?')">
                    <button type="submit" class="btn-delete-photo" style="width:28px; height:28px; font-size:16px;">√ó</button>
                </form>
            {% else %}
                <form action="/upload-location/{{ bin.id }}" method="post" enctype="multipart/form-data" style="padding:{{ header_height/4 }}px; text-align:center;">
                    <input type="file" name="file" accept="image/*" capture="environment" onchange="handleFileSelect(this, this.form)" id="up-{{ bin.id }}" style="display:none;">
                    <label for="up-{{ bin.id }}" style="cursor:pointer; color:var(--primary); font-weight:bold; font-size: {{ '1em' if level == 0 else '0.8em' }};">+ Add Photo</label>
                </form>
            {% endif %}
        </div>

        <div style="padding: 15px; border-top: 3px solid var(--primary);">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 class="clickable" onclick="document.getElementById('eb-{{ bin.id }}').style.display='block'" style="margin: 0; font-size: {{ '1.17em' if level == 0 else '1em' }};">
                    {{ bin.name }}
                </h3>
                {% if bin.location_name %}<span style="font-size:0.75em; background:#f0f0f0; padding:3px 8px; border-radius:4px;">üìç {{ bin.location_name }}</span>{% endif %}
            </div>

            <div id="eb-{{ bin.id }}" style="display:none; margin-top:15px; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #ddd;">
                <form action="/edit-bin/{{ bin.id }}" method="post">
                    <label style="font-size: 0.8em; font-weight: bold; color: #666;">Bin Name</label>
                    <input type="text" name="name" value="{{ bin.name }}" required style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                    
                    <label style="font-size: 0.8em; font-weight: bold; color: #666;">Location</label>
                    <select name="location_id" style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <option value="None">-- No Area --</option>
                        {% for loc in locations %}<option value="{{ loc.id }}" {% if bin.location_id == loc.id %}selected{% endif %}>{{ loc.name }}</option>{% endfor %}
                    </select>

                    <label style="font-size: 0.8em; font-weight: bold; color: #666;">Nest Inside Bin (Optional)</label>
                    <select name="parent_bin_id" style="width:100%; margin-bottom:15px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <option value="None">-- Top Level --</option>
                        {% for b in bins %}{% if b.id != bin.id %}<option value="{{ b.id }}" {% if bin.parent_bin_id == b.id %}selected{% endif %}>Inside: {{ b.name }}</option>{% endif %}{% endfor %}
                    </select>

                    <div style="display:flex; gap:10px; margin-bottom: 15px;">
                        <button type="submit" class="btn-save">Update</button>
                        <button type="button" onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background:#ccc; border:none; border-radius:4px; padding:10px; width:100%; cursor:pointer;">Cancel</button>
                    </div>
                </form>
                <div style="border-top: 1px solid #eee; padding-top: 15px;">
                    <form action="/delete-bin/{{ bin.id }}" method="post" onsubmit="return confirm('Retire bin? Contents will move to Unassigned.')">
                        <button type="submit" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:10px; width:100%; cursor:pointer; font-weight:bold;">üóëÔ∏è Retire Bin</button>
                    </form>
                </div>
            </div>

            <details class="items-details" style="margin-top: 10px;">
                <summary style="cursor: pointer; color: var(--primary); font-weight: bold; font-size: 0.9em; margin-bottom: 10px;">üì¶ View {{ bin_items | length }} Items</summary>
                {% for item in bin_items %}
                    <div class="item-row" style="display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                        <div class="item-thumb-container" style="width: {{ thumb_size }}px; height: {{ thumb_size }}px;">
                            {% if item.high_res_image %}
                                <a href="/highres/{{ item.high_res_image }}" target="_blank">
                                    <img src="/lowres/{{ item.high_res_image }}" class="item-thumb" style="width:100%; height:100%;">
                                </a>
                                <form action="/delete-item-photo/{{ item.id }}" method="post" onsubmit="return confirm('Delete part photo?')">
                                    <button type="submit" class="btn-delete-photo">√ó</button>
                                </form>
                            {% else %}
                                <form action="/upload-item-photo/{{ item.id }}" method="post" enctype="multipart/form-data" style="width:100%; height:100%;">
                                    <input type="file" name="image" accept="image/*" capture="environment" onchange="handleFileSelect(this, this.form)" id="item-up-{{ item.id }}" style="display:none;">
                                    <label for="item-up-{{ item.id }}" style="cursor:pointer; display:flex; align-items:center; justify-content:center; width:100%; height:100%; background:#eee; border-radius:4px; color:var(--primary); font-size:16px;">+</label>
                                </form>
                            {% endif %}
                        </div>
                        <div style="flex-grow:1; margin-left:15px;">
                            <div style="display:flex; justify-content:space-between;">
                                <span class="clickable" onclick="document.getElementById('ep-{{ item.id }}').style.display='block'" style="font-weight:600; font-size: {{ '1em' if level == 0 else '0.9em' }};">{{ item.quantity }}x {{ item.name }}</span>
                                <form action="/delete-item/{{ item.id }}" method="post" onsubmit="return confirm('Delete part?')">
                                    <button type="submit" style="background:none; border:none; cursor:pointer; opacity:0.3;">üóëÔ∏è</button>
                                </form>
                            </div>
                            <div style="color:var(--accent); font-weight:bold; font-size:0.85em;">${{ "{:.2f}".format(item.price) }}</div>
                        </div>
                    </div>
                    <div id="ep-{{ item.id }}" style="display:none; margin-top:15px; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #ddd; clear:both;">
                        <form action="/edit-item/{{ item.id }}" method="post" enctype="multipart/form-data">
                            <input type="hidden" name="household_id" value="{{ current_household_id }}">
                            <input type="text" name="name" value="{{ item.name }}" required style="width:100%; margin-bottom:10px; padding:8px;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="number" name="quantity" value="{{ item.quantity }}" style="width:30%; padding:8px;">
                                <input type="number" step="0.01" name="price" value="{{ item.price }}" style="width:70%; padding:8px;">
                            </div>
                            <label style="display:block; margin-bottom:5px; font-weight:bold;">Move to Bin:</label>
                            <select name="bin_id" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px;">
                                {% for b in bins %}<option value="{{ b.id }}" {% if b.id == item.bin_id %}selected{% endif %}>{{ b.name }}</option>{% endfor %}
                            </select>
                            <div style="display:flex; gap:10px;">
                                <button type="submit" class="btn-save">Update</button>
                                <button type="button" onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background:#ccc; border:none; border-radius:4px; padding:10px; width:100%;">Cancel</button>
                            </div>
                        </form>
                    </div>
                {% endfor %}
            </details>

            <details style="margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <summary style="cursor:pointer; color:var(--primary); font-weight:bold; font-size:0.9em;">+ Add New Part</summary>
                <form action="/add-item/{{ bin.id }}" method="post" enctype="multipart/form-data" style="margin-top:15px; background:#f9f9f9; padding:20px; border-radius:10px; border:1px solid #ddd;">
                    <input type="text" name="name" placeholder="Part Name" required style="width:100%; padding:10px; margin-bottom:10px;">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="number" name="quantity" value="1" style="width:30%; padding:10px;">
                        <input type="number" step="0.01" name="price" placeholder="$0.00" style="width:70%; padding:10px;">
                    </div>
                    <button type="submit" class="btn-save" style="margin-top:20px;">Save Part</button>
                </form>
            </details>

            {% for child in bins if child.parent_bin_id == bin.id %}
                {% set child_items = items | selectattr("bin_id", "equalto", child.id) | list %}
                {% if child.name != 'Unassigned' or child_items | length > 0 %}
                    {{ render_bin(child, level + 1, items, bins, locations, current_household_id) }}
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Fetch Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --sidebar-bg: #2c3e50; --primary: #3498db; --accent: #27ae60; --danger: #e74c3c; --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; background: #f0f2f5; height: 100vh; overflow: hidden; }
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; transition: 0.3s; position: fixed; height: 100%; z-index: 1001; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar input, .sidebar select { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); width: 100%; padding: 10px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .main-content { flex-grow: 1; margin-left: var(--sidebar-width); transition: 0.3s; height: 100vh; overflow-y: auto; width: 100%; }
        .main-content.expanded { margin-left: 0; }
        .top-bar { background: white; padding: 12px 25px; display: flex; align-items: center; border-bottom: 1px solid #e1e4e8; position: sticky; top: 0; z-index: 10; gap: 15px; }
        .bin-list-container { display: flex; flex-direction: column; gap: 25px; padding: 25px; }
        .bin-card { background: white; border-radius: 12px; border: 1px solid #e1e4e8; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 20px; }
        .btn-delete-photo { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .btn-save { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; padding: 10px; border-radius: 4px; width: 100%; text-align: center; display: block; }
        .clickable { cursor: pointer; transition: 0.2s; }
        .clickable:hover { color: var(--primary); }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div style="padding: 25px; display: flex; justify-content: space-between; align-items: center;"><strong>üì¶ PROJECT FETCH</strong><button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">√ó</button></div>
        <div style="padding: 15px; flex-grow: 1; overflow-y: auto;">
            <p style="font-size: 0.7em; opacity: 0.5; text-transform: uppercase;">Households</p>
            {% for hh in available_households %}
                <a href="/bins/{{ hh.id }}" style="text-decoration:none; color:white; display:block; padding:12px; border-radius:8px; margin-bottom:8px; {% if hh.id == current_household_id %}background:var(--primary);{% endif %}">{{ hh.name }}</a>
            {% endfor %}

            {% if current_household_id %}
            <div style="margin-top: 35px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <p style="font-size: 0.7em; opacity: 0.5;">Physical Areas</p>
                {% for loc in locations %}
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:6px; margin-bottom:8px;">
                        <span style="font-size:0.9em;">üìç {{ loc.name }}</span>
                        <form action="/delete-location/{{ loc.id }}" method="post" onsubmit="return confirm('Delete area?')"><button type="submit" style="background:none; border:none; color:white; cursor:pointer;">√ó</button></form>
                    </div>
                {% endfor %}
                <form action="/add-location/{{ current_household_id }}" method="post" style="margin-bottom:20px;"><input type="text" name="name" placeholder="+ Add Area" required></form>
                
                <p style="font-size: 0.7em; opacity: 0.5;">New Bin</p>
                <form action="/add-bin/{{ current_household_id }}" method="post">
                    <input type="text" name="name" placeholder="Name" required>
                    <select name="location_id"><option value="None">-- Select Area --</option>{% for loc in locations %}<option value="{{ loc.id }}">{{ loc.name }}</option>{% endfor %}</select>
                    <select name="parent_bin_id"><option value="None">-- Top Level --</option>{% for b in bins %}<option value="{{ b.id }}">Inside: {{ b.name }}</option>{% endfor %}</select>
                    <button type="submit" class="btn-save">Create</button>
                </form>

                <div style="margin-top:20px;">
                    <a href="/print-labels/{{ current_household_id }}" class="btn-save" style="background:var(--accent); text-decoration:none;">üñ®Ô∏è Batch Labels</a>
                    <a href="/global-search?return_to={{ current_household_id }}" class="btn-save" style="background:#9b59b6; margin-top:10px; text-decoration:none;">üîç Global Search</a>
                    {% if email == 'dbfletcher@gmail.com' %}<a href="/admin?return_to={{ current_household_id }}" class="btn-save" style="background:#444; margin-top:10px; text-decoration:none;">‚öôÔ∏è Admin Panel</a>{% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="top-bar">
            <button onclick="toggleSidebar()" style="background:none; border:none; font-size:28px; cursor:pointer;">‚ò∞</button>
            <h2 style="margin: 0;">{{ household_name or "Inventory" }}</h2>
            <button onclick="document.querySelectorAll('details').forEach(d => d.open = false)" style="background: #444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; margin-left: 15px; font-weight: bold;">Collapse All</button>
            <div style="margin-left:auto; background:var(--accent); color:white; padding:6px 15px; border-radius:25px; font-weight:bold;">Total: ${{ "{:,.2f}".format(total_value) if total_value else "0.00" }}</div>
        </div>

        {% if current_household_id %}
        <div style="padding: 15px 25px 0 25px; max-width: 800px; margin: 0 auto;">
            <input type="text" id="globalSearch" placeholder="üîç Search parts..." onkeyup="filterInventory()" style="width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; outline: none;">
        </div>
        {% endif %}

        <div class="bin-list-container">
            {# Macro is defined at top; call recursively for top-level bins #}
            {% for bin in bins if not bin.parent_bin_id %}
                {% if bin.name != 'Unassigned' %}
                    {{ render_bin(bin, 0, items, bins, locations, current_household_id) }}
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div id="cropModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:2000; flex-direction:column; align-items:center; justify-content:center;">
        <div style="width:90%; max-height:70vh; margin-bottom:20px;"><img id="imageToCrop" style="max-width:100%; display:block;"></div>
        <div style="display:flex; gap:20px;"><button onclick="cancelCrop()" style="padding:15px 30px; background:#e74c3c; color:white; border:none; border-radius:8px; font-weight:bold;">Cancel</button><button onclick="executeCrop(event)" style="padding:15px 30px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold;">Save & Upload</button></div>
    </div>

    <script>
        let cropper; let currentForm;
        function toggleSidebar() { const s = document.getElementById('sidebar'); const m = document.getElementById('mainContent'); if (window.innerWidth <= 768) { s.classList.toggle('active'); } else { s.classList.toggle('collapsed'); m.classList.toggle('expanded'); } }
        
        function filterInventory() {
            const input = document.getElementById('globalSearch').value.toLowerCase();
            const cards = document.getElementsByClassName('bin-card');
            for (let card of cards) {
                const itemRows = card.getElementsByClassName('item-row');
                const itemsDetails = card.querySelector('.items-details');
                let binHasMatch = false;
                const binHeaderMatch = card.querySelector('h3').innerText.toLowerCase().includes(input);

                for (let row of itemRows) {
                    let itemText = row.innerText.toLowerCase();
                    const isMatch = (input.length > 0 && itemText.includes(input)) || binHeaderMatch;
                    row.style.display = isMatch ? "flex" : "none";
                    if (isMatch && input.length > 0) { 
                        binHasMatch = true; 
                        if (itemsDetails) itemsDetails.open = true; 
                    }
                }
                if (input.length === 0 && itemsDetails) { itemsDetails.open = false; }
                card.style.display = (binHasMatch || binHeaderMatch || input.length === 0) ? "" : "none";
            }
        }

        function handleFileSelect(input, form) { const file = input.files[0]; if (!file) return; currentForm = form; const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('imageToCrop'); img.src = e.target.result; document.getElementById('cropModal').style.display = 'flex'; if (cropper) cropper.destroy(); cropper = new Cropper(img, { aspectRatio: NaN, viewMode: 1, dragMode: 'move' }); }; reader.readAsDataURL(file); }
        function executeCrop(e) { const eventObj = e || window.event; const saveBtn = eventObj ? eventObj.target : null; if (saveBtn) { saveBtn.disabled = true; saveBtn.innerText = "Uploading..."; } const canvas = cropper.getCroppedCanvas({ width: 1000, height: 1000 }); canvas.toBlob((blob) => { const formData = new FormData(currentForm); if (currentForm.action.includes('item') || currentForm.action.includes('add-item')) { formData.set('image', blob, 'cropped_item.jpg'); } else { formData.set('file', blob, 'cropped_bin.jpg'); } fetch(currentForm.action, { method: 'POST', body: formData }).then(r => window.location.reload()); }, 'image/jpeg', 0.8); }
        function cancelCrop() { document.getElementById('cropModal').style.display = 'none'; if (cropper) cropper.destroy(); }
    </script>
</body>
</html>
