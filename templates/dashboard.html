<!DOCTYPE html>
<html>
<head>
    <title>Project Fetch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --sidebar-bg: #2c3e50; --primary: #3498db; --accent: #27ae60; --danger: #e74c3c; --sidebar-width: 280px; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; display: flex; background: #f0f2f5; height: 100vh; overflow: hidden; }
        
        /* Sidebar Navigation */
        .sidebar { width: var(--sidebar-width); background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; transition: 0.3s; position: fixed; height: 100%; z-index: 1001; }
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar input, .sidebar select { background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.2); width: 100%; padding: 10px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .sidebar select option { color: #333; background: white; }

        /* Main Dashboard Content */
        .main-content { flex-grow: 1; margin-left: var(--sidebar-width); transition: 0.3s; height: 100vh; overflow-y: auto; width: 100%; }
        .main-content.expanded { margin-left: 0; }
        .top-bar { background: white; padding: 12px 25px; display: flex; align-items: center; border-bottom: 1px solid #e1e4e8; position: sticky; top: 0; z-index: 10; gap: 15px; }
        .error-banner { background: var(--danger); color: white; padding: 12px 20px; font-size: 0.9em; text-align: center; }
        
        /* Bin and Photo Containers */
        .bin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 25px; padding: 25px; }
        .bin-card { background: white; border-radius: 12px; border: 1px solid #e1e4e8; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .bin-photo-container { 
            width: 100%; height: 180px; background: #dfe6e9; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center; 
        }
        .bin-photo-container img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        
        .item-row { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .item-thumb-container { position: relative; width: 50px; height: 50px; flex-shrink: 0; }
        .item-thumb { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; background: #eee; cursor: pointer; }
        
        .btn-delete-photo { 
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); z-index: 5; 
        }
        .btn-save { 
            background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; padding: 10px; border-radius: 4px; width: 100%; display: block; box-sizing: border-box; text-align: center; line-height: 1.2; font-size: 14px; 
        }

        .clickable { cursor: pointer; transition: 0.2s; }
        .clickable:hover { opacity: 0.7; color: var(--primary); }
        .nested-box { margin-top: 12px; padding: 12px; background: #f1f8ff; border-radius: 8px; border-left: 4px solid var(--primary); }
        
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div style="padding: 25px; display: flex; justify-content: space-between; align-items: center;"><strong>üì¶ PROJECT FETCH</strong><button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">√ó</button></div>
        <div style="padding: 15px; flex-grow: 1; overflow-y: auto;">
            <p style="font-size: 0.7em; opacity: 0.5; text-transform: uppercase;">Households</p>
            {% for hh in available_households %}
                <a href="/bins/{{ hh.id }}" style="text-decoration:none; color:white; display:block; padding:12px; border-radius:8px; margin-bottom:8px; {% if hh.id == current_household_id %}background:var(--primary);{% endif %}">
                    {{ hh.name }}
                </a>
            {% endfor %}

            {% if current_household_id %}
            <div style="margin-top: 35px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                <p style="font-size: 0.7em; opacity: 0.5;">Physical Areas</p>
                {% for loc in locations %}
                    <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2); padding:8px 12px; border-radius:6px; margin-bottom:8px;">
                        <span style="font-size:0.9em;">üìç {{ loc.name }}</span>
                        <form action="/delete-location/{{ loc.id }}" method="post" onsubmit="return confirm('Delete area?')">
                            <button type="submit" style="background:none; border:none; color:white; cursor:pointer;">√ó</button>
                        </form>
                    </div>
                {% endfor %}
                <form action="/add-location/{{ current_household_id }}" method="post" style="margin-bottom:20px;">
                    <input type="text" name="name" placeholder="+ Add Area" required>
                </form>
                
                <p style="font-size: 0.7em; opacity: 0.5;">New Bin</p>
                <form action="/add-bin/{{ current_household_id }}" method="post">
                    <input type="text" name="name" placeholder="Name" required>
                    <select name="location_id">
                        <option value="None">-- Select Area --</option>
                        {% for loc in locations %}<option value="{{ loc.id }}">{{ loc.name }}</option>{% endfor %}
                    </select>
                    <select name="parent_bin_id">
                        <option value="None">-- Top Level --</option>
                        {% for b in bins %}<option value="{{ b.id }}">Inside: {{ b.name }}</option>{% endfor %}
                    </select>
                    <button type="submit" class="btn-save">Create</button>
                </form>
                <p style="font-size: 0.7em; opacity: 0.5; margin-top:20px;">Tools</p>
                <a href="/print-labels/{{ current_household_id }}" class="btn-save" style="display:block; text-align:center; text-decoration:none; background:var(--accent);">
                    üñ®Ô∏è Batch Print Labels
                </a>
                <a href="/global-search?return_to={{ current_household_id }}" class="btn-save" 
                    style="display:block; text-align:center; text-decoration:none; background:#9b59b6; margin-top:10px;">
                        üîç Global Inventory Search
                </a>
                {% if email == 'dbfletcher@gmail.com' %}
                <a href="/admin?return_to={{ current_household_id }}" class="btn-save" 
                   style="background:#444; margin-top:10px; text-decoration:none; display:block; text-align:center;">
                    ‚öôÔ∏è Admin Control Panel
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <div class="main-content" id="mainContent">
        {% if error %}
            <div class="error-banner">
                ‚ö†Ô∏è {{ error }}
                <form action="/delete-location/{{ error_location_id }}" method="post" style="display:inline; margin-left:15px;">
                    <input type="hidden" name="force" value="True"><button type="submit" style="background:white; color:var(--danger); border:none; border-radius:4px; padding:5px 12px; cursor:pointer; font-weight:bold;">Force Delete</button>
                </form>
            </div>
        {% endif %}

        <div class="top-bar">
            <button onclick="toggleSidebar()" style="background:none; border:none; font-size:28px; cursor:pointer;">‚ò∞</button>
            <h2 style="margin: 0;">{{ household_name or "Inventory" }}</h2>
            
            <button onclick="document.querySelectorAll('details').forEach(d => d.open = false)" 
                    style="background: #444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; margin-left: 15px; font-weight: bold;">
                Collapse All Bins
            </button>

            <div style="margin-left:auto; background:var(--accent); color:white; padding:6px 15px; border-radius:25px; font-size:0.9em; font-weight:bold;">
                Total: ${{ "{:,.2f}".format(total_value) if total_value else "0.00" }}
            </div>
        </div>
        
        {% if current_household_id %}
        <div style="padding: 15px 25px 0 25px; max-width: 800px; margin: 0 auto;">
            <input type="text" id="globalSearch" placeholder="üîç Search parts or bins..." onkeyup="filterInventory()" 
                   style="width: 100%; padding: 12px 20px; border-radius: 25px; border: 1px solid #ddd; outline: none;">
            <div style="margin-top: 8px; font-size: 0.8em; color: #666; display: flex; align-items: center; gap: 8px;">
                <input type="checkbox" id="searchMetadata" onchange="filterInventory()"> 
                <label for="searchMetadata">Include hidden metadata (Descriptions/Specs)</label>
            </div>
        </div>
        {% endif %}

        <div class="bin-grid">
            {% for bin in bins if not bin.parent_bin_id %}
                {% set bin_items = items | selectattr("bin_id", "equalto", bin.id) | list %}
                {% if bin.name != 'Unassigned' or bin_items | length > 0 %}
            <div class="bin-card">
                <div class="bin-photo-container">
                    {% if bin.location_image %}
                        <a href="/highres/{{ bin.location_image }}" target="_blank">
                            <img src="/lowres/{{ bin.location_image }}" title="Click for High-res">
                        </a>
                        <form action="/delete-location-photo/{{ bin.id }}" method="post"
                              style="position:absolute; top:8px; right:8px;"
                              onsubmit="return confirm('Delete bin photo?')">
                            <button type="submit" class="btn-delete-photo" style="width:28px; height:28px; font-size:16px;">√ó</button>
                        </form>
                    {% else %}
                        <form action="/upload-location/{{ bin.id }}" method="post" enctype="multipart/form-data" style="padding:40px; text-align:center;">
                            <input type="file" name="file" accept="image/*" capture="environment" onchange="handleFileSelect(this, this.form)" id="up-{{ bin.id }}" style="display:none;">
                            <label for="up-{{ bin.id }}" style="cursor:pointer; color:var(--primary); font-weight:bold;">+ Add Photo</label>
                        </form>
                    {% endif %}
                </div>
                <div style="padding: 20px; border-top: 5px solid var(--primary);">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 class="clickable" onclick="document.getElementById('eb-{{ bin.id }}').style.display='block'">{{ bin.name }}</h3>
                        {% if bin.location_name %}<span style="font-size:0.75em; background:#f0f0f0; padding:3px 10px; border-radius:4px;">üìç {{ bin.location_name }}</span>{% endif %}
                    </div>
                    
                    <div id="eb-{{ bin.id }}" style="display:none; margin-top:15px; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #ddd;">
                        <form action="/edit-bin/{{ bin.id }}" method="post">
                            <label style="font-size: 0.8em; font-weight: bold; color: #666;">Bin Name</label>
                            <input type="text" name="name" value="{{ bin.name }}" required style="width:100%; margin-bottom:10px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                            <label style="font-size: 0.8em; font-weight: bold; color: #666;">Location</label>
                            <select name="location_id" style="width:100%; margin-bottom:15px; padding:8px; border:1px solid #ccc; border-radius:4px;">
                                <option value="None">-- No Area --</option>
                                {% for loc in locations %}<option value="{{ loc.id }}" {% if bin.location_id == loc.id %}selected{% endif %}>{{ loc.name }}</option>{% endfor %}
                            </select>
                            <div style="display:flex; gap:10px; margin-bottom: 15px;">
                                <button type="submit" class="btn-save">Update</button>
                                <button type="button" onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background:#ccc; border:none; border-radius:4px; padding:10px; width:100%; cursor:pointer;">Cancel</button>
                            </div>
                        </form>
                        <div style="border-top: 1px solid #eee; padding-top: 15px;">
                            <form action="/delete-bin/{{ bin.id }}" method="post" onsubmit="return confirm('Retire bin?')">
                                <button type="submit" style="background:var(--danger); color:white; border:none; border-radius:4px; padding:10px; width:100%; cursor:pointer; font-weight:bold;">üóëÔ∏è Retire Bin</button>
                            </form>
                        </div>
                    </div>

                    <details style="margin-top: 10px;">
                        <summary style="cursor: pointer; color: var(--primary); font-weight: bold; font-size: 0.9em; margin-bottom: 10px; outline: none;">
                            üì¶ View {{ bin_items | length }} Items
                        </summary>
                        {% for item in items if item.bin_id == bin.id %}
                            <div class="item-row">
                                <div class="item-thumb-container">
                                    {% if item.high_res_image %}
                                        <a href="/highres/{{ item.high_res_image }}" target="_blank">
                                            <img src="/lowres/{{ item.high_res_image }}" class="item-thumb">
                                        </a>
                                        <form action="/delete-item-photo/{{ item.id }}" method="post" onsubmit="return confirm('Delete photo?')">
                                            <button type="submit" class="btn-delete-photo">√ó</button>
                                        </form>
                                    {% else %}
                                        <form action="/upload-item-photo/{{ item.id }}" method="post" enctype="multipart/form-data" style="width:100%; height:100%;">
                                            <input type="file" name="image" accept="image/*" capture="environment" onchange="handleFileSelect(this, this.form)" id="item-up-{{ item.id }}" style="display:none;">
                                            <label for="item-up-{{ item.id }}" style="cursor:pointer; display:flex; align-items:center; justify-content:center; width:50px; height:50px; background:#eee; border-radius:4px; color:var(--primary); font-size:20px;">+</label>
                                        </form>
                                    {% endif %}
                                </div>
                                <div style="flex-grow:1; margin-left:15px;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <span class="clickable" onclick="document.getElementById('ep-{{ item.id }}').style.display='block'" style="font-weight:600;">{{ item.quantity }}x {{ item.name }}</span>
                                        <form action="/delete-item/{{ item.id }}" method="post" onsubmit="return confirm('Delete part?')">
                                            <button type="submit" style="background:none; border:none; cursor:pointer; opacity:0.3;">üóëÔ∏è</button>
                                        </form>
                                    </div>
                                    <div style="color:var(--accent); font-weight:bold; font-size:0.9em;">${{ "{:.2f}".format(item.price) }}</div>
                                </div>
                            </div>
                            
                            <div id="ep-{{ item.id }}" style="display:none; margin-top:15px; background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #ddd; clear:both;">
                                <form action="/edit-item/{{ item.id }}" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="household_id" value="{{ current_household_id }}">
                                    <input type="text" name="name" value="{{ item.name }}" required style="width:100%; margin-bottom:10px; padding:8px;">
                                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                                        <input type="number" name="quantity" value="{{ item.quantity }}" style="width:30%; padding:8px;">
                                        <input type="number" step="0.01" name="price" value="{{ item.price }}" style="width:70%; padding:8px;">
                                    </div>
                                    <label style="display:block; margin-bottom:5px; font-weight:bold;">Move to Bin:</label>
                                    <select name="bin_id" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; margin-bottom:15px;">
                                        {% for b in bins %}<option value="{{ b.id }}" {% if b.id == item.bin_id %}selected{% endif %}>{{ b.name }}</option>{% endfor %}
                                    </select>
                                    <div style="display:flex; gap:10px;">
                                        <button type="submit" class="btn-save">Update</button>
                                        <button type="button" onclick="this.parentElement.parentElement.parentElement.style.display='none'" style="background:#ccc; border:none; border-radius:4px; padding:10px; width:100%;">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        {% endfor %}
                    </details>

                    {% for child in bins if child.parent_bin_id == bin.id %}
                        <div class="nested-box">
                            <strong>üìÇ {{ child.name }}</strong>
                            {% for item in items if item.bin_id == child.id %}<div style="font-size:0.9em; margin-top:6px; color:#555;">‚Ä¢ {{ item.quantity }}x {{ item.name }}</div>{% endfor %}
                        </div>
                    {% endfor %}

                    <details style="margin-top:25px; border-top:1px solid #eee; padding-top:15px;">
                        <summary style="cursor:pointer; color:var(--primary); font-weight:bold; font-size:0.95em;">+ Add New Part</summary>
                        <form action="/add-item/{{ bin.id }}" method="post" enctype="multipart/form-data" style="margin-top:15px; background:#f9f9f9; padding:20px; border-radius:10px; border:1px solid #ddd;">
                            <input type="text" name="name" placeholder="Part Name" required style="width:100%; padding:10px; margin-bottom:10px;">
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <input type="number" name="quantity" value="1" style="width:30%; padding:10px;">
                                <input type="number" step="0.01" name="price" placeholder="$0.00" style="width:70%; padding:10px;">
                            </div>
                            <button type="submit" class="btn-save" style="margin-top:20px;">Save Part</button>
                        </form>
                    </details>
                </div>
            </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div id="cropModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:2000; flex-direction:column; align-items:center; justify-content:center;">
        <div style="width:90%; max-height:70vh; margin-bottom:20px;"><img id="imageToCrop" style="max-width:100%; display:block;"></div>
        <div style="display:flex; gap:20px;">
            <button onclick="cancelCrop()" style="padding:15px 30px; background:#e74c3c; color:white; border:none; border-radius:8px; font-weight:bold;">Cancel</button>
            <button onclick="executeCrop(event)" style="padding:15px 30px; background:#27ae60; color:white; border:none; border-radius:8px; font-weight:bold;">Save & Upload</button>
        </div>
    </div>

    <script>
        let cropper; let currentForm;
        function toggleSidebar() {
            const s = document.getElementById('sidebar'); const m = document.getElementById('mainContent');
            if (window.innerWidth <= 768) { s.classList.toggle('active'); }
            else { s.classList.toggle('collapsed'); m.classList.toggle('expanded'); }
        }

        function filterInventory() {
            const input = document.getElementById('globalSearch').value.toLowerCase();
            const includeMetadata = document.getElementById('searchMetadata').checked;
            const cards = document.getElementsByClassName('bin-card');

            for (let card of cards) {
                const itemRows = card.getElementsByClassName('item-row');
                let binHasMatch = false;

                // 1. Check Bin Name/Area
                const binHeader = card.querySelector('h3').innerText.toLowerCase();
                const areaTag = card.querySelector('span[style*="background:#f0f0f0"]')?.innerText.toLowerCase() || "";
                const binHeaderMatch = binHeader.includes(input) || areaTag.includes(input);
                
                // Target the items details element for this card
                const itemsDetails = card.querySelector('details');

                // 2. Loop through each item
                for (let row of itemRows) {
                    let itemText = row.innerText.toLowerCase();
                    const isMatch = (input.length > 0 && itemText.includes(input)) || binHeaderMatch;
                    
                    row.style.display = isMatch ? "flex" : "none";

                    if (isMatch && input.length > 0) {
                        binHasMatch = true;
                        // AUTO-EXPAND: Open the bin if there's a search match
                        if (itemsDetails) itemsDetails.open = true;
                    }
                }

                // 3. Reset to Collapsed: If search is cleared, collapse per your default preference
                if (input.length === 0 && itemsDetails) {
                    itemsDetails.open = false;
                }

                // 4. Hide/Show Bin Card
                card.style.display = (binHasMatch || binHeaderMatch || input.length === 0) ? "" : "none";
            }
        }
        function handleFileSelect(input, form) {
            const file = input.files[0]; if (!file) return; currentForm = form;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('imageToCrop'); img.src = e.target.result;
                document.getElementById('cropModal').style.display = 'flex';
                if (cropper) cropper.destroy();
                cropper = new Cropper(img, { aspectRatio: NaN, viewMode: 1, dragMode: 'move' });
            };
            reader.readAsDataURL(file);
        }

        function executeCrop(e) {
            const eventObj = e || window.event; const saveBtn = eventObj ? eventObj.target : null;
            if (saveBtn) { saveBtn.disabled = true; saveBtn.innerText = "Uploading..."; }
            const canvas = cropper.getCroppedCanvas({ width: 1000, height: 1000 });
            canvas.toBlob((blob) => {
                const formData = new FormData(currentForm);
                if (currentForm.action.includes('item') || currentForm.action.includes('add-item')) {
                    formData.set('image', blob, 'cropped_item.jpg'); 
                } else { formData.set('file', blob, 'cropped_bin.jpg'); }
                fetch(currentForm.action, { method: 'POST', body: formData }).then(r => window.location.reload());
            }, 'image/jpeg', 0.8);
        }

        function cancelCrop() { document.getElementById('cropModal').style.display = 'none'; if (cropper) cropper.destroy(); }
    </script>
</body>
</html>
