<!DOCTYPE html>
<html>
<head>
    <title>Admin - Project Fetch</title>
    <style>
        :root { --primary: #3498db; --accent: #27ae60; --danger: #e74c3c; }
        body { font-family: sans-serif; padding: 40px; background: #f4f7f6; color: #333; }
        .admin-box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        .btn { border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; text-decoration: none; display: inline-block; }
        .btn-link { background: var(--accent); color: white; }
        .btn-edit { background: #f39c12; color: white; font-size: 0.8em; }
        .btn-delete { background: var(--danger); color: white; font-size: 0.8em; }
        input[type="text"], input[type="email"], select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="admin-box">
        <a href="{% if return_id %}/bins/{{ return_id }}{% else %}/{% endif %}" style="text-decoration:none; color:var(--primary);">‚Üê Back to Dashboard</a>
        <h2 style="margin-top:20px;">üè† Household Management</h2>
        <form action="/admin/add-household{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" name="name" placeholder="New Household Name" required style="flex-grow:1;">
            <button type="submit" class="btn btn-link">Add Household</button>
        </form>
        <table>
            <thead><tr><th>ID</th><th>Name</th><th>Actions</th></tr></thead>
            <tbody>
                {% for h in households %}
                <tr>
                    <td>{{ h.id }}</td>
                    <td>
                        <form id="edit-h-{{ h.id }}" action="/admin/edit-household/{{ h.id }}{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:none;">
                            <input type="text" name="name" value="{{ h.name }}" required>
                            <button type="submit" class="btn btn-edit">Save</button>
                        </form>
                        <span id="display-h-{{ h.id }}">{{ h.name }}</span>
                    </td>
                    <td>
                        <button onclick="toggleEdit('h-{{ h.id }}')" class="btn btn-edit">Edit</button>
                        <form action="/admin/delete-household/{{ h.id }}{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:inline;" onsubmit="return confirm('Delete household?')">
                            <button type="submit" class="btn btn-delete">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="admin-box">
        <h2>üë§ User Management</h2>
        <form action="/admin/add-user{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="email" name="email" placeholder="user@email.com" required style="flex-grow:1;">
            <button type="submit" class="btn btn-link">Create User</button>
        </form>
        <table>
            <thead><tr><th>ID</th><th>Email</th><th>Actions</th></tr></thead>
            <tbody>
                {% for u in users %}
                <tr>
                    <td>{{ u.id }}</td>
                    <td>
                        <form id="edit-u-{{ u.id }}" action="/admin/edit-user/{{ u.id }}{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:none;">
                            <input type="email" name="email" value="{{ u.email }}" required>
                            <button type="submit" class="btn btn-edit">Save</button>
                        </form>
                        <span id="display-u-{{ u.id }}">{{ u.email }}</span>
                    </td>
                    <td>
                        <button onclick="toggleEdit('u-{{ u.id }}')" class="btn btn-edit">Edit</button>
                        <form action="/admin/delete-user/{{ u.id }}{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:inline;" onsubmit="return confirm('Delete user?')">
                            <button type="submit" class="btn btn-delete">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="admin-box">
        <h2>‚öôÔ∏è User Access Linker</h2>
        <form action="/admin/link-user{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" style="display:flex; gap:10px; margin-bottom:30px;">
            <select name="user_id" required>
                <option value="">-- Select User --</option>
                {% for u in users %}<option value="{{ u.id }}">{{ u.email }}</option>{% endfor %}
            </select>
            <select name="household_id" required>
                <option value="">-- Select Household --</option>
                {% for h in households %}<option value="{{ h.id }}">{{ h.name }}</option>{% endfor %}
            </select>
            <button type="submit" class="btn btn-link">Grant Access</button>
        </form>

        <h3>Current Access Map (Sorted by User)</h3>
        <table>
            <thead><tr><th>User Email</th><th>Household</th><th>Action</th></tr></thead>
            <tbody>
                {% for m in memberships %}
                <tr>
                    <td><strong>{{ m.email }}</strong></td>
                    <td>{{ m.household_name }}</td>
                    <td>
                        <form action="/admin/revoke-access/{{ m.membership_id }}{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" onsubmit="return confirm('Revoke access?')">
                            <button type="submit" style="background:none; border:none; color:var(--danger); cursor:pointer; font-weight:bold;">Revoke</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="admin-box">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0;">üõ†Ô∏è Recent Activity Feed</h3>
            <form action="/admin/clear-logs{% if return_id %}?return_to={{ return_id }}{% endif %}" method="post" onsubmit="return confirm('Wipe history?')">
                <button type="submit" class="btn btn-delete">üóëÔ∏è Clear All History</button>
            </form>
        </div>
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: white;">
            {% for log in activity %}
            <div style="padding: 10px; border-bottom: 1px solid #f0f0f0; font-size: 0.9em;">
                <span style="color: #666;">[{{ log.created_at.strftime('%Y-%m-%d %H:%M') }}]</span>
                <strong>{{ log.email }}</strong>
                <span style="background: #e8f4fd; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin: 0 5px;">{{ log.action_type }}</span>
                {{ log.description }} <em>({{ log.household_name }})</em>
            </div>
            {% else %}
            <div style="text-align: center; color: #999; padding: 20px;">No activity recorded yet.</div>
            {% endfor %}
        </div>
        <footer style="margin-top: 30px; text-align: center; color: #888; font-size: 0.8em;">
            Project Fetch Version: <strong style="color: var(--primary);">{{ version }}</strong>
        </footer>
    </div>

    <script>
        function toggleEdit(id) {
            const form = document.getElementById('edit-' + id);
            const display = document.getElementById('display-' + id);
            form.style.display = (form.style.display === 'none') ? 'inline-block' : 'none';
            display.style.display = (display.style.display === 'none') ? 'inline-block' : 'none';
        }
    </script>
</body>
</html>
