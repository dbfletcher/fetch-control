<!DOCTYPE html>
<html>
<head>
    <title>Batch Print Labels - Project Fetch</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* 1. Base UI Styles (Visible on screen) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f4f7f6; 
            color: #333;
        }
        
        .no-print { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
        }
        
        .bin-selector { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 15px; 
            background: #fff;
        }

        /* 2. Dynamic Print Configuration */
        #print-area { 
            display: none; 
            /* Defaulting to Medium (3-column) view */
            --cols: 3; 
            --card-height: 2.5in; 
            --qr-size: 1.6in;
            --font-size: 14px;
        }

        @media print {
            /* Overrides browser defaults to maximize printable area */
            @page { 
                margin: 0.3in; 
            }

            .no-print { 
                display: none; 
            }

            #print-area {
                display: grid;
                /* Grid layout updates dynamically via JavaScript */
                grid-template-columns: repeat(var(--cols), 1fr);
                gap: 10px; 
                width: 100%;
                margin: 0;
            }

            .label-card {
                border: 1px dashed #ccc;
                padding: 10px;
                text-align: center;
                page-break-inside: avoid;
                /* Dynamic height based on selection */
                height: var(--card-height); 
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            /* Forces the QR code to scale with the label size */
            .label-card img, .label-card div canvas {
                max-height: var(--qr-size) !important;
                width: auto !important;
            }

            .label-card .bin-name {
                font-weight: bold;
                font-size: var(--font-size);
                margin-bottom: 5px;
                line-height: 1.2;
            }

            .label-card .footer-text {
                font-size: 10px; 
                color: #666; 
                margin-top: 5px;
            }
        }

        /* 3. Button & Utility Styles */
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background 0.2s;
        }
        
        .btn-primary { 
            background: #3498db; 
            color: white; 
        }
        
        .btn-primary:hover { 
            background: #2980b9; 
        }

        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="no-print">
        <a href="/bins/{{ household_id }}" style="text-decoration:none; color:#3498db;">‚Üê Back to Dashboard</a>
        <h2>Batch Print QR Labels: {{ household_name }}</h2>
        
        <label><strong>Label Size:</strong></label>
        <select id="sizeConfig" onchange="updateLabelSize(this.value)">
            <option value="large">Large (2 per row - ~8 per page)</option>
            <option value="medium" selected>Medium (3 per row - ~12 per page)</option>
            <option value="small">Small (4 per row - ~20 per page)</option>
        </select>
        <div class="bin-selector">
            <label><input type="checkbox" onclick="toggleAll(this)"> <strong>Select All</strong></label><br>
            {% for bin in bins %}
                <label><input type="checkbox" class="bin-check" data-id="{{ bin.id }}" data-name="{{ bin.name }}"> {{ bin.name }}</label>
            {% endfor %}
        </div>
        
        <button class="btn btn-primary" onclick="prepareAndPrint()">Generate & Print</button>
        <footer style="margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid #ddd; color: #888; font-size: 0.8em;">
            Project Fetch Version: <strong style="color: var(--primary);">{{ version }}</strong>
        </footer>
    </div>

    <div id="print-area"></div>

    <script>
        function toggleAll(source) {
            document.querySelectorAll('.bin-check').forEach(cb => cb.checked = source.checked);
        }

        function prepareAndPrint() {
            const area = document.getElementById('print-area');
            area.innerHTML = '';
            const selected = document.querySelectorAll('.bin-check:checked');
            
            if (selected.length === 0) return alert("Select at least one bin.");

            selected.forEach(cb => {
                const id = cb.dataset.id;
                const name = cb.dataset.name;
                const label = document.createElement('div');
                label.className = 'label-card';
                label.innerHTML = `<div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${name}</div><div id="qr-${id}"></div><div style="font-size:10px; color:#666; margin-top:5px;">Project Fetch</div>`;
                area.appendChild(label);
                
                new QRCode(document.getElementById(`qr-${id}`), {
                    text: `${window.location.origin}/bins/view/${id}`,
                    width: 100,
                    height: 100
                });
            });

            setTimeout(() => { window.print(); }, 500);
        }

        function updateLabelSize(size) {
            const area = document.getElementById('print-area');
            const configs = {
                'large':  { cols: 2, height: '4.8in', qr: '3.5in' },
                'medium': { cols: 3, height: '2.5in', qr: '1.6in' },
                'small':  { cols: 4, height: '1.8in', qr: '1.1in' }
            };
            
            const c = configs[size];
            area.style.setProperty('--cols', c.cols);
            area.style.setProperty('--card-height', c.height);
            area.style.setProperty('--qr-size', c.qr);
        }
    </script>
</body>
</html>
