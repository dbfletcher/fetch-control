<!DOCTYPE html>
<html>
<head>
    <title>Batch Print Labels - Project Fetch</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f7f6; }
        .no-print { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .bin-selector { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 15px; }

        /* Print Layout Configuration */
        #print-area { display: none; }

        @media print {
            @page {
                margin: 0.3in; /* Reclaims top and bottom whitespace */
            }

            .no-print { display: none; }

            #print-area {
                display: grid;
                /* FIX: Uses the dropdown variable, defaulting to 4 if not set */
                grid-template-columns: repeat(var(--cols, 4), 1fr); 
                gap: 5px; 
                width: 100%;
                margin: 0;
            }

            .label-card {
                border: 1px dashed #ccc;
                padding: 5px; 
                text-align: center;
                page-break-inside: avoid;
                /* REDUCED: 1.8in ensures 5 rows fit on 11in Letter paper */
                height: 1.8in; 
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden; 
            }

            /* Prevent the QR code from pushing the label height out */
            .label-card img, .label-card div canvas {
                max-height: 1.1in !important; 
                width: auto !important;
            }

            .label-card div {
                margin: 2px 0;
                line-height: 1.1;
            }
        }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3498db; color: white; }
    </style>
</head>
<body>
    <div class="no-print">
        <a href="/bins/{{ household_id }}" style="text-decoration:none; color:#3498db;">‚Üê Back to Dashboard</a>
        <h2>Batch Print QR Labels: {{ household_name }}</h2>
        
        <label><strong>Labels per Row:</strong></label>
        <select id="colConfig" onchange="document.getElementById('print-area').style.setProperty('--cols', this.value)">
            <option value="2">2 (Large)</option>
            <option value="3">3 (Standard - ~15 per page)</option>
            <option value="4" selected>4 (Small - ~20 per page)</option>
        </select>

        <div class="bin-selector">
            <label><input type="checkbox" onclick="toggleAll(this)"> <strong>Select All</strong></label><br>
            {% for bin in bins %}
                <label><input type="checkbox" class="bin-check" data-id="{{ bin.id }}" data-name="{{ bin.name }}"> {{ bin.name }}</label>
            {% endfor %}
        </div>
        
        <button class="btn btn-primary" onclick="prepareAndPrint()">Generate & Print</button>
        <footer style="margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid #ddd; color: #888; font-size: 0.8em;">
            Project Fetch Version: <strong style="color: var(--primary);">{{ version }}</strong>
        </footer>
    </div>

    <div id="print-area"></div>

    <script>
        function toggleAll(source) {
            document.querySelectorAll('.bin-check').forEach(cb => cb.checked = source.checked);
        }

        function prepareAndPrint() {
            const area = document.getElementById('print-area');
            area.innerHTML = '';
            const selected = document.querySelectorAll('.bin-check:checked');
            
            if (selected.length === 0) return alert("Select at least one bin.");

            selected.forEach(cb => {
                const id = cb.dataset.id;
                const name = cb.dataset.name;
                const label = document.createElement('div');
                label.className = 'label-card';
                label.innerHTML = `<div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${name}</div><div id="qr-${id}"></div><div style="font-size:10px; color:#666; margin-top:5px;">Project Fetch</div>`;
                area.appendChild(label);
                
                new QRCode(document.getElementById(`qr-${id}`), {
                    text: `${window.location.origin}/bins/view/${id}`,
                    width: 100,
                    height: 100
                });
            });

            setTimeout(() => { window.print(); }, 500);
        }
    </script>
</body>
</html>
