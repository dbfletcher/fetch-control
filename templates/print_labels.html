<!DOCTYPE html>
<html>
<head>
    <title>Batch Print Labels - Project Fetch</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* 1. Base UI Styles (Screen View) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f4f7f6; 
            color: #333;
        }
        
        .no-print { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin-bottom: 30px; 
        }
        
        .bin-selector { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
            margin: 20px 0; 
            max-height: 400px; 
            overflow-y: auto; 
            border: 1px solid #eee; 
            padding: 15px; 
            background: #fff;
        }

        /* 2. Dynamic Print Configuration */
        #print-area { 
            display: none; 
            /* Defaulting to Medium view */
            --cols: 3; 
            --card-height: 2.3in; 
            --qr-size: 1.4in;
            --font-size: 13px;
            --grid-gap: 8px;
            --card-pad: 8px;
        }

        @media print {
            @page { 
                margin: 0.3in; /* Reclaims top/bottom workspace */
            }

            .no-print { display: none; }

            #print-area {
                display: grid;
                grid-template-columns: repeat(var(--cols), 1fr);
                gap: var(--grid-gap); 
                width: 100%;
                margin: 0;
            }

            .label-card {
                border: 1px dashed #ccc;
                padding: var(--card-pad);
                text-align: center;
                page-break-inside: avoid;
                height: var(--card-height); 
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                /* CRITICAL: Ensures padding is included in the height calculation */
                box-sizing: border-box; 
            }

            .label-card div[id^="qr-"] {
                display: flex;
                justify-content: center;
                align-items: center;
                height: var(--qr-size);
                width: var(--qr-size);
                margin: 2px 0;
            }

            .label-card img, .label-card canvas {
                max-height: 100% !important;
                max-width: 100% !important;
                width: auto !important;
                height: auto !important;
            }

            .label-card .bin-name {
                font-weight: bold;
                font-size: var(--font-size);
                margin-bottom: 2px;
                line-height: 1.1;
                word-wrap: break-word;
            }

            .label-card .footer-text {
                font-size: 9px; 
                color: #666; 
                margin-top: 2px;
            }
        }

        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3498db; color: white; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="no-print">
        <a href="/bins/{{ household_id }}" style="text-decoration:none; color:#3498db;">‚Üê Back to Dashboard</a>
        <h2>Batch Print QR Labels: {{ household_name }}</h2>
        
        <label><strong>Label Size:</strong></label>
        <select id="sizeConfig" onchange="updateLabelSize(this.value)">
            <option value="large">Large (2 per row - ~8 per page)</option>
            <option value="medium" selected>Medium (3 per row - ~12 per page)</option>
            <option value="small">Small (4 per row - ~20 per page)</option>
        </select>
        <div class="bin-selector">
            <label><input type="checkbox" onclick="toggleAll(this)"> <strong>Select All</strong></label><br>
            {% for bin in bins %}
                <label><input type="checkbox" class="bin-check" data-id="{{ bin.id }}" data-name="{{ bin.name }}"> {{ bin.name }}</label>
            {% endfor %}
        </div>
        
        <button class="btn btn-primary" onclick="prepareAndPrint()">Generate & Print</button>
        <footer style="margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid #ddd; color: #888; font-size: 0.8em;">
            Project Fetch Version: <strong style="color: var(--primary);">{{ version }}</strong>
        </footer>
    </div>

    <div id="print-area"></div>

    <script>
        function toggleAll(source) {
            document.querySelectorAll('.bin-check').forEach(cb => cb.checked = source.checked);
        }

        function prepareAndPrint() {
            const area = document.getElementById('print-area');
            area.innerHTML = '';
            const selected = document.querySelectorAll('.bin-check:checked');

            if (selected.length === 0) return alert("Select at least one bin.");

            // 1. Determine the QR pixel size based on the current dropdown selection
            const sizeMode = document.getElementById('sizeConfig').value;
            const qrPixelSizes = {
                'large': 300,  // Approx 3.5in at 96dpi
                'medium': 160, // Approx 1.6in
                'small': 110   // Approx 1.1in
            };
            const qrSize = qrPixelSizes[sizeMode] || 150;

            selected.forEach(cb => {
                const id = cb.dataset.id;
                const name = cb.dataset.name;
                const label = document.createElement('div');
                label.className = 'label-card';
                
                // 2. Added 'bin-name' and 'footer-text' classes for the new CSS styles
                label.innerHTML = `
                    <div class="bin-name">${name}</div>
                    <div id="qr-${id}"></div>
                    <div class="footer-text">Project Fetch</div>
                `;
                area.appendChild(label);

                // 3. Generate QR code with the dynamic size
                new QRCode(document.getElementById(`qr-${id}`), {
                    text: `${window.location.origin}/bins/view/${id}`,
                    width: qrSize,
                    height: qrSize,
                    correctLevel: QRCode.CorrectLevel.H // Higher error correction for larger prints
                });
            });

            setTimeout(() => { window.print(); }, 500);
        }

        function updateLabelSize(size) {
            const area = document.getElementById('print-area');
            const configs = {
                // Fits 2 rows perfectly (4 labels)
                'large':  { cols: 2, height: '4.8in', qr: '3.3in', gap: '10px', pad: '10px', font: '18px' },
                // Fits 4 rows perfectly (12 labels)
                'medium': { cols: 3, height: '2.3in', qr: '1.4in', gap: '8px', pad: '8px', font: '13px' },
                // Fits 5 rows perfectly (20 labels)
                'small':  { cols: 4, height: '1.8in', qr: '1.1in', gap: '5px', pad: '5px', font: '11px' }
            };
            
            const c = configs[size];
            area.style.setProperty('--cols', c.cols);
            area.style.setProperty('--card-height', c.height);
            area.style.setProperty('--qr-size', c.qr);
            area.style.setProperty('--grid-gap', c.gap);
            area.style.setProperty('--card-pad', c.pad);
            area.style.setProperty('--font-size', c.font);
        }
    </script>
</body>
</html>
